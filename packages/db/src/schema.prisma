// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -------------------------------- User -------------------------------- 

/**
 * The model 'user' contains the basic information
 * about the User, It also contains a link to the account,
 * that contains all the extra info such as username, desription...
 */
model User {
  id            String         @id @unique @default(uuid())
  email         String         @unique
  role          Role           @default(USER)
  password      String
  refreshTokens RefreshToken[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  posts         Post[]
  profile       Profile?

  friends                Friendship[]    @relation("UserFriendships")
  friendOf               Friendship[]    @relation("FriendUser")
  sentFriendRequests     FriendRequest[] @relation("SentRequests")
  receivedFriendRequests FriendRequest[] @relation("ReceivedRequests")

  likes    Like[]
  comments Comment[]
}

model Profile {
  id          String   @id @unique @default(uuid())
  username    String   @unique
  dateOfBirth DateTime
  fullName    String
  avatarId    String?  @unique
  bannerId    String?  @unique
  bio         String   @default("unknown")
  userId      String   @unique

  avatar Avatar? @relation(fields: [avatarId], references: [id], onDelete: Cascade)
  banner Banner? @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id          String   @id @unique @default(uuid())
  hashedToken String   @unique
  userId      String
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expireAt    DateTime
}

enum Role {
  USER
  ADMIN
}

model Avatar {
  id        String   @id @unique @default(uuid())
  url       String   @default("/pfp_placeholder.png")
  profile   Profile?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id        String   @id @unique @default(uuid())
  url       String   @default("/bg_placeholder.jpg")
  profile   Profile?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------------- Friends -------------------------------- 

model FriendRequest {
  id         Int                 @id @default(autoincrement())
  senderId   String
  receiverId String
  status     FriendRequestStatus @default(PENDING)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  sender     User                @relation("SentRequests", fields: [senderId], references: [id])
  receiver   User                @relation("ReceivedRequests", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Friendship {
  userId    String
  friendId  String
  createdAt DateTime @default(now())

  user   User @relation("UserFriendships", fields: [userId], references: [id])
  friend User @relation("FriendUser", fields: [friendId], references: [id])

  @@id([userId, friendId])
  @@unique([userId, friendId])
}

// -------------------------------- Posts -------------------------------- 

model Comment {
  id        String   @id @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  text      String
  post      Post     @relation(fields: [postId], references: [id])
  postId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
}

model Like {
  id     String @id @unique @default(uuid())
  post   Post   @relation(fields: [postId], references: [id])
  postId String
  user   User   @relation(fields: [userId], references: [id])
  userId String
}

enum PostBgColor {
  Deep_blue    @map("45, 75, 130, 255")
  Dark_magenta @map("130, 45, 75, 255")
  Dark_olive   @map("75, 130, 45, 255")
  Brownish     @map("130, 100, 45, 255")
  Deep_purple  @map("75, 45, 130, 255")
  Teal_ish     @map("45, 130, 100, 255")
  Indigo       @map("100, 45, 130, 255")
  Rust         @map("130, 75, 45, 255")
  Muted_blue   @map("60, 90, 150, 255")
  Muted_pink   @map("150, 60, 90, 255")
  Muted_green  @map("60, 150, 90, 255")
  Burnt_orange @map("150, 90, 60, 255")
  Dark_violet  @map("90, 60, 150, 255")
  Dark_lime    @map("90, 150, 60, 255")
  Dark_rose    @map("120, 60, 120, 255")
  Normal       @map("124, 181, 255, 0.0745")
}

model Post {
  id         String      @id @unique @default(uuid())
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  text       String
  published  Boolean     @default(true)
  author     User        @relation(fields: [authorId], references: [id])
  authorId   String
  color      PostBgColor @default(Normal)
  categories Category[]
  comments   Comment[]
  likes      Like[]
}

model Category {
  id    Int    @id @unique @default(autoincrement())
  name  String @unique
  posts Post[]
}
